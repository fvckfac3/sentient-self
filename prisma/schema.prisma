// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  name             String?
  image            String?
  passwordHash     String?
  createdAt        DateTime          @default(now())
  subscriptionTier SubscriptionTier  @default(FREE)
  institutionId    String?
  onboardingDone   Boolean           @default(false)
  preferredModel   String            @default("deepseek-chat")
  
  // Stripe billing fields
  stripeCustomerId     String?       @unique
  stripeSubscriptionId String?       @unique
  
  // Relations
  accounts         Account[]
  sessions         Session[]
  baselineProfile  BaselineProfile?
  conversations    Conversation[]
  journalEntries   JournalEntry[]
  exercises        ExerciseCompletion[]
  declinations     ExerciseDeclination[]
  streaks          UserStreak[]
  institution      Institution?      @relation(fields: [institutionId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model BaselineProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  primaryIntents   String[]
  currentChallenges String[]
  emotionalBaseline String[]
  tonePreference   String
  exerciseOpenness String
  recoveryStage    String?
  substances       String[]
  createdAt        DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String            @id @default(uuid())
  userId    String
  state     ConversationState @default(CONVERSATIONAL_DISCOVERY)
  createdAt DateTime          @default(now())
  
  // Gate validation tracking
  gateCondition1_challengeArticulated Boolean @default(false)
  gateCondition2_aiReflectedAccurately Boolean @default(false)
  gateCondition3_userEmotionallyRegulated Boolean @default(true) // Default true, AI can override
  gateCondition4_structureExplained Boolean @default(false)
  gateCondition5_noRecentDecline Boolean @default(true) // Default true, set false on decline
  lastDeclinedAt DateTime?
  
  // Exercise facilitation tracking
  activeExerciseId       String?
  activeFrameworkId      String?
  currentPhaseIndex      Int        @default(0)
  exerciseStartedAt      DateTime?
  exerciseCompletedAt    DateTime?
  exerciseReflection     String?    @db.Text
  exercisesCompleted     Int        @default(0)
  
  messages  Message[]
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  createdAt      DateTime    @default(now())
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Framework {
  id               String   @id // e.g., "trauma-alchemy-transformation"
  name             String   // e.g., "The Trauma Alchemy Transformation"
  coreMechanism    String   @db.Text
  description      String   @db.Text
  therapeuticBasis Json     // Array of strings
  phases           Json     // Array of phase objects
  deliverables     Json     // Array of deliverable strings
  bestSuitedFor    Json     // Array of strings
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  exercises        Exercise[] @relation("FrameworkExercises")
  
  @@index([id])
}

model Exercise {
  id        String @id
  title     String
  framework String // Foreign key to Framework.id
  topic     String?
  aspect    String
  aiPrompt  String @db.Text
  
  frameworkData    Framework @relation("FrameworkExercises", fields: [framework], references: [id], onDelete: Cascade)
  completions      ExerciseCompletion[]
  declinations     ExerciseDeclination[]
  
  @@index([framework])
  @@index([topic])
}

model ExerciseCompletion {
  id          String   @id @default(uuid())
  userId      String
  exerciseId  String
  reflection  String   @db.Text
  completedAt DateTime @default(now())
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
}

model JournalEntry {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime @default(now())
  mood      Int?     // 1-10 scale
  energy    Int?     // 1-10 scale
  content   String   @db.Text
  gratitude String?  @db.Text
  goals     String?  @db.Text
  insights  String?  @db.Text // AI-generated insights (premium feature)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId, date])
}

model Institution {
  id        String @id @default(uuid())
  name      String
  seatLimit Int
  
  users User[]
}

enum SubscriptionTier {
  FREE
  PREMIUM
  INSTITUTION
}

enum ConversationState {
  INIT
  CONVERSATIONAL_DISCOVERY
  SUPPORTIVE_PROCESSING
  EXERCISE_SUGGESTION
  EXERCISE_FACILITATION
  POST_EXERCISE_INTEGRATION
  CRISIS_MODE
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

model ExerciseDeclination {
  id          String   @id @default(uuid())
  userId      String
  exerciseId  String
  reason      String?
  declinedAt  DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
}

model UserStreak {
  id              String   @id @default(uuid())
  userId          String
  streakType      StreakType
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, streakType])
}

enum StreakType {
  DAILY_LOGIN
  EXERCISE_COMPLETION
  JOURNAL_ENTRY
}